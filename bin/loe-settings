#!/usr/bin/python3

# takes 1 argument - the profile name.
# finds /home/maze/.config/unity3d/LoE/loe-settings-presets/profilename.json
# collects loe settings
# applies these settings to the following files:
# /home/maze/.config/unity3d/LoE/Legends of Equestria/VideoSettings.json
# /home/maze/.config/unity3d/LoE/Legends of Equestria/GuiSettingsV2.json
# /home/maze/.config/unity3d/LoE/Legends of Equestria/prefs

import string
import os
import sys
import json
import xml.etree.ElementTree
import argparse
import base64
import subprocess

# parser = argparse.ArgumentParser()
# parser.add_argument('-u', '--username', help='choose username by index', type=int)
# parser.add_argument('profile', nargs=1, help='the profile file name (without .json)')
# args = parser.parse_args()

usernames = ['#', '?', 'redsbone', 'potatodustfifth', 'pdf', 'w', 'j',
             '[', ']', '[]', '][', '[[]]', '[][]', '[server]', '^', '-.-', 'dun', '!']

positions = [
    (0, 0),
    (0, 0),
    (640, 0),
    (1280, 0),
    (0, 540),
    (640, 540),
    (1280, 540),
    (0, 0),
    (640, 0),
    (1280, 0),
    (0, 540),
    (640, 540),
    (1280, 540),
    (1280, 540),
    (0, 0),
    (0, 0),
    (0, 0)
]

# profilename = args.profile[0]
# usernameindex = 0
# if args.username:
#     usernameindex = args.username
# encodedusername = base64.b64encode(usernames[usernameindex].encode('ascii')).decode("utf-8")


profilename = sys.argv[1]
usernameindex = 0
positionindex = 0
if len(sys.argv) > 2:
    usernameindex = int(sys.argv[2])
    positionindex = usernameindex
    if len(sys.argv) > 3:
        positionindex = int(sys.argv[3])
posx = positions[positionindex][0]
posy = positions[positionindex][1]

encodedusername = base64.b64encode(usernames[usernameindex].encode('ascii')).decode("utf-8")

with open('/home/maze/.config/unity3d/LoE/Legends of Equestria/prefs', 'r') as content_file:
    prefsstr = content_file.read()

with open('/home/maze/.config/unity3d/LoE/loe-settings-presets/'+profilename+'.json', 'r') as content_file:
    settingsstr = content_file.read()

parts = settingsstr.split('\n-\n')

video = json.loads(parts[0])

width = video['Resolution']['width']
height = video['Resolution']['height']

with open("/home/maze/.config/unity3d/LoE/Legends of Equestria/VideoSettings.json", 'w') as outfile:
    outfile.write(parts[0])
with open("/home/maze/.config/unity3d/LoE/Legends of Equestria/GuiSettingsV2.json", 'w') as outfile:
    outfile.write(parts[1])

prefs = xml.etree.ElementTree.fromstring(prefsstr)

for pref in prefs.findall('pref'):
    if pref.get('name') == 'Screenmanager Resolution Height':
        pref.text = str(height - 53 + 53)
    if pref.get('name') == 'Screenmanager Resolution Width':
        pref.text = str(width)
    if pref.get('name') == 'clickTut':
        prefs.remove(pref)
    if pref.get('name') == 'username':
        pref.text = encodedusername


modprefsstr = xml.etree.ElementTree.tostring(prefs, encoding='unicode')

with open("/home/maze/.config/unity3d/LoE/Legends of Equestria/prefs", 'w') as outfile:
    outfile.write(str(modprefsstr))

if profilename == '6' and (posx != 0 or posy != 0):
    subprocess.Popen(['loe-move-latest', '4', str(posx), str(posy)])
